// Prisma schema (structure-only, latest Prisma ORM style)

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

/// ======================================================================
/// ARCHITECTURE NOTES
/// ----------------------------------------------------------------------
/// - Business invariants are enforced in DOMAIN and APPLICATION layers
/// - Database acts as durable storage, not a rule engine
/// - DB enums are used ONLY for stable lifecycle states
/// - Flexible classifications remain app-level enums (stored as strings)
/// ======================================================================

/// Stable lifecycle enum → safe for DB-level enum
enum WorkPeriodStatus {
  OPEN
  CLOSED
}

model AuthIdentity {
  id             String   @id @default(uuid()) @db.Uuid
  driverId       String   @db.Uuid

  provider       String   // 'google'
  providerUserId String   // Google `sub`
  email          String

  createdAt DateTime @default(now())

  driver Driver @relation(fields: [driverId], references: [id], onDelete: Restrict)

  @@unique([provider, providerUserId])
  @@unique([email])
  @@index([driverId])
}


model Driver {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())

  workPeriods WorkPeriod[]
  leaveEvents LeaveEvent[]

  receivedTransfers ShiftTransferEvent[] @relation("TransferReceiver")
  givenTransfers    ShiftTransferEvent[] @relation("TransferGiver")
  authIdentities AuthIdentity[]
}

model WorkPeriod {
  id                String            @id @default(uuid()) @db.Uuid
  driverId          String            @db.Uuid
  declaredStartTime DateTime
  declaredEndTime   DateTime?
  status            WorkPeriodStatus
  createdAt         DateTime          @default(now())

  driver      Driver          @relation(fields: [driverId], references: [id], onDelete: Restrict)
  corrections WorkCorrection[]

  shiftTransfers ShiftTransferEvent[]

  @@index([driverId, status])
  @@index([driverId, declaredStartTime])
}

model WorkCorrection {
  id                 String   @id @default(uuid()) @db.Uuid
  workPeriodId       String   @db.Uuid
  correctedStartTime DateTime
  correctedEndTime   DateTime
  reason             String?
  createdAt          DateTime @default(now())

  workPeriod WorkPeriod @relation(fields: [workPeriodId], references: [id], onDelete: Restrict)

  @@index([workPeriodId, createdAt(sort: Desc)])
}

model LeaveEvent {
  id                String   @id @default(uuid()) @db.Uuid
  driverId          String   @db.Uuid
  declaredStartTime DateTime
  declaredEndTime   DateTime
  leaveType         String?        // app-level enum (evolves over time)
  createdAt         DateTime @default(now())

  driver      Driver           @relation(fields: [driverId], references: [id], onDelete: Restrict)
  corrections LeaveCorrection[]

  @@index([driverId, declaredStartTime])
}

model LeaveCorrection {
  id                 String   @id @default(uuid()) @db.Uuid
  leaveId            String   @db.Uuid
  correctedStartTime DateTime
  correctedEndTime   DateTime
  reason             String?
  createdAt          DateTime @default(now())

  leave LeaveEvent @relation(fields: [leaveId], references: [id], onDelete: Restrict)

  @@index([leaveId, createdAt(sort: Desc)])
}

model ShiftTransferEvent {
  id                     String   @id @default(uuid()) @db.Uuid
  driverId               String   @db.Uuid              // receiving driver
  transferredFromDriverId String  @db.Uuid              // optional giver
  workPeriodId           String  @db.Uuid              // contextual only
  reason                 String?
  createdAt              DateTime @default(now())

  /// Relations
  driver                Driver     @relation("TransferReceiver", fields: [driverId], references: [id], onDelete: Restrict)
  transferredFromDriver Driver    @relation("TransferGiver", fields: [transferredFromDriverId], references: [id], onDelete: Restrict)
  workPeriod            WorkPeriod @relation(fields: [workPeriodId], references: [id], onDelete: Restrict)

  @@index([driverId, createdAt])
  @@index([workPeriodId])
}

model EntryProjection {
  /// Entry identity (same as source event ID)
  id        String @id @db.Uuid
  driverId  String @db.Uuid

  /// Classification
  /// Allowed values (by convention, not DB enum):
  /// - "WORK"
  /// - "LEAVE"
  type      String

  /// Effective times (authoritative for reads)
  effectiveStartTime DateTime
  effectiveEndTime   DateTime?

  /// Provenance (rebuild-only metadata)
  /// - sourceId   → WorkPeriod.id | LeaveEvent.id
  /// - sourceType → "work_period" | "leave_event"
  sourceId   String @db.Uuid
  sourceType String

  /// Projection bookkeeping
  /// createdAt → copied from source event
  /// updatedAt → auto-updated on correction
  createdAt DateTime
  updatedAt DateTime @updatedAt

  /// Query performance indexes
  @@index([driverId, effectiveStartTime])
  @@index([driverId, effectiveEndTime])
  @@index([driverId, effectiveStartTime, effectiveEndTime])

  /// Explicit table name (important)
  @@map("entries_projection")
}
